---
title: 支持 SV48 分页机制
linkTitle: 01.SV48
weight: 12
---

`SV48` （`Supervisor-mode Virtual Memory`）是一种基于 `RISC-V` 的页表虚拟内存寻址模式，指定了 `48` 位虚拟地址空间的结构，支持 `256TB` 的虚拟内存地址空间。使用四级页表结构：

![Sv48_vaddr](Sv48_vaddr.png)

![Sv48_paddr](Sv48_paddr.png) 

![Sv48_pagetable](Sv48_pagetable.png)

在 `SV48` 的一个 `PTE` 中包含了如下字段：

- `N`: 
    - 指示是否为 `NAPOT PTE`。供 `Svnapot` 扩展使用，如果未实现 `Svnapot` 则该位必须由软件置 `0`，否则应当出现 `Page Fault`。目前香山昆明湖架构尚未支持此扩展。

- `PBMT`: 
    - `Page-Based Memory Types`，即基于页面的内存类型，供 `Svpbmt` 扩展使用，允许操作系统为每个页面指定不同的内存访问属性。
        - `0`: `None`，没有特定的内存属性。
        - `1`: `NC`，非缓存、幂等、弱序（`RVWMO`），适用于主存。
        - `2`: `IO`，非缓存、非幂等、强序（`I/O` 排序），适用于 `I/O` 设备。
        - `3`: `Reserved`，保留供将来标准使用。
        
    同样的，如果未实现 `Svpbmt` 则这两位必须由软件置 `0`，否则应当出现 `Page Fault`。

- `Reserved`: 
    - 保留位，供未来的标准使用。如果有任意一位不是 `0` 则会触发 `PF` 异常。

- `PPN`: 
    - 表示物理页框号，指向实际的物理内存页。`PPN` 与页面内偏移结合形成完整的物理地址，用于地址转换。

- `RSW`: 
    - 保留供软件使用的位，通常用于特定的标志或操作，以便在软件实现中提供灵活性。

- `D`: 
    - 脏位，指示该页面是否被写入。如果该位为 `1`，表示该页的数据已被修改，需在换出时写回到存储设备。

- `A`: 
    - 访问位，指示该页是否被访问过。如果该位为 `1`，表示该页已被读取或写入，用于页面替换算法。

- `G`: 
    - 全局页位，指示该页是否是全局页。如果该位为 `1`，表示该页对所有进程可见，用于共享代码或数据。

- `U`: 
    - 用户访问权限位，指示该页是否可被用户（`U`）模式访问。如果该位为 `1`，用户模式可以访问该页；若为 `0`，则仅限于特权模式。

- `X`: 
    - 可执行位，指示该页是否可执行。如果该位为 `1`，表示该页可以执行代码；若为 `0`，则不可执行。

- `W`: 
    - 可写位，指示该页是否可写。如果该位为 `1`，表示该页可以写入数据；若为 `0`，则不可写。

- `R`: 
    - 可读位，指示该页是否可读。如果该位为 `1`，表示该页可以读取数据；若为 `0`，则不可读。

- `V`: 
    - 有效位，指示该页表项是否有效。如果该位为 `1`，表示该项有效，可以进行地址转换；若为 `0`，则表示该项无效。

值得一提的是，如果该 `PTE` 并不是叶子 `PTE`，即它所存储的 `PPN` 用来指向下一级页表，那么它的 `X`、`W`、`R` 位应全为零。在手册中的要求如下：

![XWR 示意图](XWR.png)

`RISC-V H` 扩展即 `Hypervisor` 扩展，增加了对虚拟化和 `hypervisor` 模式的支持，将会允许虚拟机监控程序和虚拟机的管理程序，允许操作系统运行在虚拟机上，并可以通过 `hypervisor` 调度虚拟机的运行。在 `hypervisor` 下使用 `SV48x4` 寻址模式，支持四倍页表扩展。

![Sv48x4 虚拟地址](Sv48x4.png)

`VPN[3]` 进行了两位的扩展，也即大小从原来的 `4KB` 变为 `16KB`，支持 $2^{11}$ 个 `PTE`。值得注意的是，`SV48x4` 作用于虚拟机物理地址 `VPA`，在虚拟机上创建进程地址空间时仍然采用的是 `SV48`。也正是因此，虚拟机进行虚实地址转换的时候，首先将 `48` 位的虚拟机虚拟地址（`GVA`）转换为 `50` 位的虚拟机物理地址（`GPA`），之后再将 `GPA`（相当于主机的 `HVA`）转换为主机物理地址（`HPA`）。在页表项中存储的是 `44` 位的 `PPN`，这是由 `56` 位的物理地址去掉 `12` 位的页内偏移得到的，因此完全可以存的下扩展了两位（`38` 位）的 `VPN`。

出于对面积等的优化考虑，在香山中采用 `48` 位的主机物理地址，而不是 `Sv48` 要求的 `56` 位物理地址，这是因为 `48` 位的物理地址已经可以索引 `256TB` 的物理地址空间，目前来说已经足够使用。但是由于 `TLB` 对虚拟机的支持，在虚拟机两阶段地址转换过程中（两阶段地址转换可见支持两阶段虚实地址翻译过程部分），虚拟机通过 `VS` 阶段转换的结果仍然是 `56` 位的虚拟机物理地址，只不过在进入 `G` 阶段地址转换时，`G` 阶段要求传入的 `GPA` 的高 `6` 位必须为 `0`，这是因为在 `Sv48x4` 中客户机物理地址要求为 `50` 位，而 `VS` 阶段得到的物理地址是 `56` 位。为了保持 `gpaddr` 的完整性，`PTW` 传入 `TLB` 的 `ppn` 信号的位宽依然为 `44` 位，然而由于 `TLB` 不存储中间转换结果（中间物理地址 `IPA`），也就不需要存储 `44` 位的 `ppn`，在 `TLB` 表项中存储的只有主机的 `ppn`，也即 `36` 位的 `ppn`。