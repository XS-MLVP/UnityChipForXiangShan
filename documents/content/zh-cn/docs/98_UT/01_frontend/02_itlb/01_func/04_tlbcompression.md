---
title: 支持 TLB 压缩
linkTitle: 04.TLBCompression
weight: 12
---

随着虚拟地址空间的不断扩展，传统 `TLB` 的大小和效率面临挑战，可能不足以覆盖应用程序的需求，导致频繁的缺失（`TLB miss`），从而影响系统性能，导致性能瓶颈。为了应对这一问题，`TLB` 压缩技术应运而生，旨在提高 `TLB` 的有效性和性能。

在操作系统分配内存的时候，由于使用伙伴地址分配策略等原因，会倾向于将连续的物理页分配给连续的虚拟页。虽然随着程序的不断运行，页分配逐渐的从有序趋向于无序，但是这种页的相连性普遍存在，因此可以通过将多个连续的页表项在 `TLB` 硬件中合成为一个 `TLB` 项，以增大 `TLB` 容量。`TLB` 压缩通过优化页表结构，支持连续的映射，通过引入范围映射（`range mapping`）机制，一个 `TLB` 条目可以映射一段连续的虚拟地址到一段连续的物理地址。

在实际中，以香山昆明湖架构为例，在 `TLB` 中存储 `35` 位的 `vpn_high`（即 `tag`），剩下的三位用于索引对应的 `ppn_low`（一共有 `8` 个所以需要 `3` 位来索引）。每次匹配中，`TLB` 用传入的 `vaddr[49:15]`（高 `35` 位）与 `tag` 进行匹配，找到对应的条目，这个条目中可以存储 `8` 个 `PTE`，再根据 `vaddr[14:12]` 找到对应的 `ppn_low`，之后检查对应的 `valididx` 是否有效，如果有效说明 `hit`，将 `ppn_low` 与 `ppn_high` 拼接得到 `PPN`，再与 `vaddr[11:0]` 拼接得到 `paddr`。

![香山 TLB 压缩示意图](TLB压缩.png)

在支持了 `H` 扩展后（见支持两阶段虚实地址翻译），`TLB` 压缩仅在 `OnlyStage1` 和 `noS2xlate` 下启用，在其他情况下不启用。

支持 `TLB` 压缩后 `TLB` 中缓存的条目会有所变化（表中未提及的条目即没有变化）：

| 是否压缩 | tag   | ppn   | valididx | pteidx | ppn_low      |
|----------|-------|-------|----------|--------|--------------|
| 否       | 38位  | 36位  | 不保存   | 不保存 | 不保存       |
| 是       | 35位  | 33位  | 8位      | 8位    | 8×3位        |

在支持了大小页的情况下，`TLB` 压缩在大页情况下（`2MB/1GB/512GB`）不启用，仅在查询结果为小页（`4KB`）情况下启用。大页在返回时会将 `valididx` 的 `8` 位全部设置为 `1`，而由于大页的查询过程中只需要 `PPN` 的高位，大页下不使用 `ppn_low`，`ppn_low` 的值在此时是未定义的。