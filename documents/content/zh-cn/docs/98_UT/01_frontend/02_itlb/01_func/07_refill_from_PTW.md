---
title: 支持读取 PTW 返回条目
linkTitle: 07.refill_from_PTW
weight: 12
---

每次 `TLB` 发生 `miss` 之后，会向 `L2TLB` 发送 `Page Table Walk` 请求。由于 `TLB` 与 `L2TLB` 之间有比较长的物理距离，需要在中间加拍，这项工作由 `repeator` 完成。同时，`repeator` 还需要对 `PTW` 请求进行过滤，以避免 `TLB` 中出现重复项，因此也被称为 `filter`。目前香山中 `TLB` 发出的 `PTW` 请求的内容包含 `VPN`、`s2xlate`、`getGPA` 三个信号以及必要的控制信号：

- **VPN**：
  - 虚拟页框号，`TLB` 在 `miss` 之后会将 `VPN` 发送给 `PTW` 用于索引对应的物理页，`PTW` 会将叶子页表的 `PPN` 返回给 `TLB`，下次 `TLB` 查询的时候就可以找到该页并可以通过页内偏移找到物理地址。

- **s2xlate**：
  - 两阶段地址转换标志，指示当前的两阶段地址转换模式。`TLB` 中该标志将通过 `vsatp` 与 `hgatp` 寄存器的 `mode` 域进行判断：

  | s2xlate | vsatp.mode | hgatp.mode |
  |---------|------------|-------------|
  | 0b00    | 0          | 0           |
  | 0b01    | 1          | 0           |
  | 0b10    | 0          | 1           |
  | 0b11    | 1          | 1           |

- **getGPA**：
  - 指示当前 `PTW` 请求是否为请求客户机物理地址。用于客户机缺页等情况的处理（详见支持发生 `GPF` 时重新发起请求部分）。

在支持了 `TLB` 压缩后，`PTW` 返回的结果主要包括 `resp_valid`、`tag[33:0]`、`asid[15:0]`、`perm[6:0]`、`level[1:0]`、`ppn[35:0]`、`addr_low[2:0]`、`ppn_low[2:0]` × `8`、`valididx` × `8`、`pteidx` × `8`、`pf`、`af`（各个信号的含义可见支持缓存映射条目部分）。`TLB` 接收到有效的 `PTW resp` 后即将这些条目存进自己的缓存中。

在支持了 `H` 扩展后，`TLB` 压缩仅在 `noS2xlate` 和 `onlyStage1` 时启用，需要添加 `s2xlate` 信号指示两阶段地址转换的类型，并分开返回 `s1` 和 `s2`。其中，`s1` 阶段可以与之前的主机地址转换合并，在主机地址转换中，`s1` 添加的部分信号以及位宽不适用，添加或扩充的信号如下所示：

| 支持 H 扩展 | s2xlate[1:0] | tag     | vmid[13:0] | ppn     | s2 | getGPA |
|------------|--------------|---------|------------|---------|----|--------|
| 否         | 无           | [32:0]  | 无         | [32:0]  | 无 | 无     |
| 是         | 有           | [34:0]  | 有         | [40:0]  | 有 | 有     |

其中，`tag` 扩充的两位是由于虚拟机采用 `Sv48x4`，将 `hypervisor` 下的虚拟地址从 `48` 位扩充为 `50` 位，因此 `tag` 相应需要多两位。`vmid` 指示虚拟机号。`ppn` 多的 `8` 位是因为主机采用 `48` 位物理地址，而第一阶段转换出来的虚拟机物理地址为 `56` 位（在进入下一阶段时要求前 `6` 位是 `0`，变为 `50` 位），`getGPA` 可见后面支持发生 `GPF` 时重新发起请求部分。

`s2` 部分用于第二阶段地址转换，即从虚拟机物理地址到主机物理地址的转换，此时 `asid` 无效，`resp` 的信号包括 `tag[37:0]`、`vmid[13:0]`、`ppn[37:0]`、`perm[6:0]`、`level`、`gpf`、`gaf`。由于不考虑 `TLB` 压缩，`tag` 即为 `38` 位，来自 `50` 位虚拟地址的高 `38` 位。值得注意，在目前的香山昆明湖架构中，这里的 `ppn` 有效的位数仅有后 `36` 位，之所以 `ppn` 位宽为 `38` 位是出于优化的需要，香山 `TLB` 中通过 `readResult` 方法从 `PTW` 中读取信息，`s1`、`s2` 阶段复用了 `readResult` 方法，由于在 `s1` 阶段的需要用到 `50` 位的物理地址，`readResult.ppn` 被定义为 `38` 位，以至于在 `verilog` 文件中传入 `s2.ppn` 时也需要额外多传 `2` 位，事实上这两位仅仅传进 `TLB` 中而不起作用，可以忽略。

| 支持 H 扩展 | s2_tag[37:0] | s2_vmid[14:0] | s2_ppn[37:0] | s2_perm[6:0] | s2_level[1:0] | gpf | gaf |
|--------------|---------------|----------------|--------------|---------------|----------------|-----|-----|
| 否           | 无            | 无             | 无           | 无            | 无             | 无  | 无  |
| 是           | 有            | 有             | 有           | 有            | 有             | 有  | 有  |

添加了 `H` 拓展后的 `MMU`，`PTW` 返回的结构分为三部分，第一部分 `s1` 是原先设计中的 `PtwSec-torResp`，存储第一阶段翻译的页表，第二部分 `s2` 是 `HptwResp`，存储第二阶段翻译的页表，第三部分是 `s2xlate`，代表这次 `resp` 的类型，仍然分为 `noS2xlate`、`allStage`、`onlyStage1` 和 `onlyStage2`。如下图。其中 `PtwSectorEntry` 是采用了 `TLB` 压缩技术的 `PtwEntry`。

![PTW resp 结构示意图](PTW_resp结构示意.png)