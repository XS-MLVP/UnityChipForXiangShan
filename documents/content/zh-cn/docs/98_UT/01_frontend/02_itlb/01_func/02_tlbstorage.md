---
title: 支持缓存映射条目
linkTitle: 02.TLBStorage
weight: 12
---

`TLB` 中存储的条目并不是页表项 `PTE`，而是一个映射，一个从虚拟地址（来自于请求）到物理地址（来自于查找结果）的映射，当然还有一些访问所必须的信息。在目前的香山中 `TLB` 所存储的条目包含 `tag[35]`、`asid[16]`、`vmid[14]`、`level[2]`、`ppn[33]`、`8 × ppn_low[3]`、`8 × valididx`、`8 × pteidx`、`s2xlate`、`perm[6]`、`g_perm[4]`。为供以后使用 `svpbmt` 扩展，还存储了 `pbmt` 与 `g_pbmt` 字段。

![TLB 缓存条目](TLBstore.png)

- **tag[34:0]**
  - `tag`，用于匹配条目。来源于 `VPN` 的高 `35` 位，在匹配的过程中，输入一个 `38` 位的 `VPN`，通过将输入的 `VPN` 的前 `35` 位与 `tag` 比较找到对应的条目，可以看到在一个条目中存储了 `PPN` 的高位部分和 `8` 个 `ppn_low`，之后将 `VPN` 的后三位作为索引，可以索引这 `8` 个 `ppn_low`，即可将 `ppn` 与 `ppn_low[vpn_low]` 拼接得到物理页框号。

- **asid[15:0]**
  - 地址空间标识符，用于区分不同的进程地址空间。

- **vmid[13:0]**
  - 虚拟机标识符，用于区分不同的虚拟机。

- **level[1:0]**
  - 指示页面的大小。`0`：`4KB`，`1`：`2MB`，`2`：`1GB`，`3`：`512GB`。

- **ppn[32:0]**
  - 物理页框号的高 `33` 位。在 `Sv48` 要求下本该是 `41` 位，出于面积考虑优化至 `33` 位（见支持 `Sv48` 分页机制部分）。

- **ppn_low[2:0]×8**
  - 物理页框号的低 `3` 位。用于 `TLB` 压缩（见支持 `TLB` 压缩部分）。

- **valididx×8**
  - 指示对应的 `ppn_low` 是否有效。用于 `TLB` 压缩，为 `0` 表示条目无效，即对应物理地址没有存储页表条目。

- **pteidx×8**
  - 指示原始请求对应压缩条目的哪一项。例如 `vpn` 低三位为 `010`，那么 `pteidx[3]` 为 `1`，其它 `7` 位为 `0`。

- **s2xlate[1:0]**
  - 指示是否启用两阶段地址转换。`0b00`：不启用，`0b01`：仅使用第一阶段，`0b10`：仅使用第二阶段，`0b11`：启用两阶段地址转换。

- **perm[5:0]**
  - 指示主机的权限以及异常信息，包括 `pf`、`af`、`a`、`g`、`u`、`x` 六位。其中 `pf`（`page fault`）指示是否发生缺页异常；`af`（`access fault`）指示是否发生地址错误等访问错误异常；`a`（`access`）指示该表项是否最近被访问过，任何形式的访问（包括读、写、取指）均会将 `a` 位置 `1`，用于页面替换算法；`g`（`global`）指示该条目指向的页面是否为全局页面；`u`（`user`）指示该条目指向的页面是否可以被用户模式访问，`u` 位为 `1` 说明可以被 `UMode` 访问，为 `0` 说明可以被 `SMode` 访问；`x`（执行）指示该条目指向的页面是否可执行，`itlb` 用于取指的加速，所有取出的条目必须是可执行的。

- **g_perm[3:0]**
  - 指示虚拟机的权限以及异常信息，包括 `gpf`、`gaf`、`a`、`x` 四位，虚拟机的 `g` 和 `u` 两位不单独存储，与主机共用。一般情况下虚拟机对全局页、用户模式的处理与主机相同，而替换策略与访问权限控制可能不同，所以共用了 `g`、`u` 而不共用 `a`、`x`。`gpf`（`guest page fault`）为虚拟机缺页异常，`gaf`（`guest access fault`）为虚拟机访问错误异常。

香山的 `ITLB` 采用 `48` 项全相联的结构，保存全部大小页，共能存储 `48` 条映射。

在支持 `H` 扩展的前提下，对于不同的 `s2xlate` 的状态 `TLB` 中存储的条目的值代表的意义也会有所区别：

| 类型         | s2xlate | tag                           | ppn                          | perm                           | g_perm      | level                         |
|--------------|---------|-------------------------------|------------------------------|--------------------------------|-------------|-------------------------------|
| noS2xlate    | b00     | 非虚拟化下的虚拟页号          | 非虚拟化下的物理页号          | 非虚拟化下的页表项 perm         | 不使用      | 非虚拟化下的页表项 level      |
| allStage     | b11     | 第一阶段页表的虚拟页号        | 第二阶段页表的物理页号        | 第一阶段页表的 perm             | 第二阶段页表的 perm | 两阶段翻译中最大的 level      |
| onlyStage1   | b01     | 第一阶段页表的虚拟页号        | 第一阶段页表的物理页号        | 第一阶段页表的 perm             | 不使用      | 第一阶段页表的 level          |
| onlyStage2   | b10     | 第二阶段页表的虚拟页号        | 第二阶段页表的物理页号        | 不使用                           | 第二阶段页表的 perm | 第二阶段页表的 level          |

支持 `H` 扩展后 `TLB` 中缓存的条目会有所变化（表中未提及的条目即没有变化）：

| 支持 H 扩展 | vmid | s2xlate | g_perm |
|--------------|------|---------|--------|
| 否           | 不保存 | 不保存 | 不保存 |
| 是           | 14位 | 2位     | 4位    |