---
title: 支持发生 GPF 时重新发起 PTW 请求
linkTitle: 09.guest_page_fault
weight: 12
---

在香山的 `TLB` 中并不会保存中间物理地址。在两阶段地址转换过程中，如果第一阶段发生缺页异常，即 `PTW` 返回 `gpf`，此时 `TLB` 将 `PTW` 返回的结果存入 `TLB` 项内，请求方再次请求的时候发现 `gpf`，此时 `TLB` 会返回 `miss`，即使已经存储了这个映射。同时，`TLB` 将发起带 `getGPA` 标志的 `PTW` 请求，请求这个虚拟地址，并维护一组寄存器暂存相关信号：

| 信号                     | 作用                                                         |
|--------------------------|--------------------------------------------------------------|
| need_gpa                 | 表示此时有一个请求正在获取 gpaddr                           |
| need_gpa_robidx         | 存储请求的 ROB（Reorder Buffer）索引，用于跟踪请求来源，目前未使用 |
| need_gpa_vpn[37:0]      | 存储请求的 vpn，即 50 位虚拟地址的高 38 位                 |
| need_gpa_gvpn[43:0]     | 存储获取的 gpaddr 的 gvpn，虚拟机通过转换得到的 56 位虚拟机物理地址的高 44 位，前六位在第二阶段地址转换中被要求为全 0 |
| need_gpa_refill          | 表示该请求的 gpaddr 已经被填入 need_gpa_gvpn              |

每当 `TLB` 发起带 `getGPA` 标志的请求时，就会将 `need_gpa` 置 `1`，并将请求的 `vpn` 填入到 `need_gpa_vpn` 中，同时将 `need_gpa_refill` 置 `0`。当 `PTW` 返回结果的时候，`TLB` 将 `PTW resp` 中的 `vpn` 提取出来与 `need_gpa_vpn` 进行比较，判断是否是对之前 `getGPA` 请求的回应。如果是，那么将 `PTW resp` 中的 `s2 tag` 填入到 `need_gpa_gvpn` 中并将 `need_gpa_refill` 置 `1`，表示已经获取到需要的 `gvpn`。下一次 `TLB` 接收到相同请求时就可以通过 `need_gpa_gvpn` 得到 `gpaddr`，之后 `TLB` 会将 `need_gpa` 置 `0`，但保留其它寄存器，因此下次其它的请求发生 `gpf` 时也可以再次使用相同的 `need_gpa_vpn` 找到 `paddr` 而无需再次发起 `PTW` 请求。

注意这里的 `gvpn` 是 `44` 位的，这是由于客户机采用 `56` 位物理地址，为了维护 `gpaddr` 的完整性，所以在这里需要存储 `44` 位的 `gvpn`，但是事实上 `gvpn` 的前 `6` 位一定会是 `0`，否则说明第一阶段产生了错误的物理地址，会触发 `gpf`，在此时需要将错误信息保存在 `mtval2/htval` 寄存器中，因此需要完整的 `gpaddr`，正常情况下并不需要。（当发生页面错误时，`mtval2` 将被填充为生成错误的物理地址，帮助异常处理程序；`htval` 将被填充为导致异常的虚拟地址，帮助 `hypervisor` 识别问题）

如果发生了 `redirect`，即重定向（可能触发了跳转/分支指令等或发生异常），此时之前的指令可能不会再访问 `TLB`，`TLB` 需要根据 `robidx` 跟踪请求来源，有选择性地刷新相关的寄存器（即上表中提到的）。目前香山昆明湖架构中尚未实现，而是通过在需要 `redirect` 的时候发送 `flushPipe` 指令来实现的，无论哪一个请求端口被刷新均会导致这些寄存器被刷新。

`getGPA` 标志并不用于判断指令是否是请求 `gpaddr`，`PTW` 不需要关心请求是干什么的，只需要负责查找并返回结果；`TLB` 内会通过一系列寄存器的比较来判断。这个信号的作用在于防止 `TLB` 重填，每次 `TLB` 发送带 `getGPA` 标志的请求时，`PTW` 在返回时会将 `getGPA` 信号传递回 `TLB`，从而使 `TLB` 不进行重填，不存储此项 `gpaddr`。