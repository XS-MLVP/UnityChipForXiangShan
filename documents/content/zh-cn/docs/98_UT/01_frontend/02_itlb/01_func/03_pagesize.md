---
title: 支持保存全部大小页
linkTitle: 03.pagesize
weight: 12
---

在 `RISC-V` 架构中，大小页机制旨在优化虚拟内存的使用效率和性能。`Sv48` 支持多种页面大小，包括 `4KB`、`2MB`、`1GB` 页，在标准的设计中没有定义 `512GB` 的页，理论上可行，但目前并没有这样的需要，`512GB` 的页也无法加载进内存，因此标准不做要求。但是出于对完整性的考虑，香山中依然实现了对 `512GB` 大页的支持。

![Sv48 大小页示意图](Sv48大小页示意图.png)

在一般的应用程序需求中，`4KB` 的页面足够满足日常的使用，可以存储较小的数据结构以及程序等，常用于大多数应用程序中。然而，有的程序可能会需要频繁访问大的数据结构或数据集，这时引入大页可以提升内存访问效率。每个大页覆盖的虚拟地址空间更大，可以显著减少页表条目的数量；在映射相同数量的内存时，所需的页表条目会大幅降低，这可以减少内存开销、减少页表查找频率，从而优化内存访问速度，尤其对频繁访问大块内存的应用，能够显著提升性能。大页通常包含连续的数据，可以提高命中率，更有效地利用缓存资源。

当然，由于大页覆盖的地址空间较大，可能导致内存碎片，而未被使用的大页空间无法被其他请求有效利用，也会浪费一定的内存资源。同时，管理不同大小的页面为内存管理带来了额外的复杂性。在混合使用小页和大页时，操作系统需要复杂的算法来优化内存分配和使用。现代操作系统通常采用混合使用大小页的模式以满足不同应用的不同需求。

在香山的 `TLB` 中，支持保存任意大小的页面，这是通过保存页面的 `level` 来实现的。根据不同的 `level`，可以决定最终生成物理地址的方法（`index` 为页内偏移，来源于 `vaddr` 的低 `12` 位；`ppn`、`ppn_low`、`tag` 来源于 `TLB` 中存储的映射条目）：

| level | 页面大小 | paddr[47:0]                           |
|-------|----------|---------------------------------------|
| 0     | 4KB      | ppn[32:0] + ppn_low[2:0] + index[11:0] |
| 1     | 2MB      | ppn[32:6] + tag[8:0] + index[11:0]      |
| 2     | 1GB      | ppn[32:15] + tag[17:0] + index[11:0]    |
| 3     | 512GB    | ppn[32:24] + tag[26:0] + index[11:0]    |